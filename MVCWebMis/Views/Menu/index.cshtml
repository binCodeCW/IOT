@{
    ViewBag.Title = "菜单信息";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@*脚本引用放在此处可以实现自定义函数自动提示*@
<script src="~/Scripts/CommonUtil.js"></script>

<div class="portlet box green-meadow col-md-3" style="width:250px">
    <div class="portlet-title">
        <div class="caption">
            <i class="fa fa-filter"></i>菜单列表
        </div>
        <div class="tools">
            <button type="button" class="btn btn-circle btn-sm green-meadow" onclick="refreshTree()">
                <i class="fa fa-refresh"></i>
                刷新
            </button>
        </div>
    </div>

    <div class="portlet-body flip-scroll">
        <div class="row">
            <div id="jstree_div"></div>
        </div>
    </div>
</div>

<div class="portlet box col-md-9">
    <div class="portlet-body flip-scroll" style="width:99%">
        <!-- BEGIN 数据查询-->
        <div class="portlet box green-meadow">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-filter"></i>查询内容
                </div>
                <div class="tools">
                    <button type="button" class="btn btn-circle btn-sm green-meadow" onclick="Refresh()">
                        <i class="fa fa-search"></i>
                        查 询
                    </button>
                    <button type="button" class="btn btn-circle btn-sm green-meadow" onclick="ShowExport()">
                        <i class="fa fa-file-excel-o"></i>
                        导 出
                    </button>
                    <a href="javascript:;" class="collapse" title="折叠内容"></a>
                </div>
            </div>

            <div class="portlet-body flip-scroll">
                <div class="row">
                    <form class="form-horizontal" id="ffSearch">
                        <div class="col-md-4 col-sm-4 col-xs-6">
                            <div class="form-group">
                                <label class="control-label col-md-4">显示名称</label>
                                <div class="col-md-8">
                                    <input name="WHC_Name" type="text" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-4 col-xs-6">
                            <div class="form-group">
                                <label class="control-label col-md-4">功能ID</label>
                                <div class="col-md-8">
                                    <input name="WHC_FunctionId" type="text" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-4 col-xs-6">
                            <div class="form-group">
                                <label class="control-label col-md-4">Web连接地址</label>
                                <div class="col-md-8">
                                    <input name="WHC_Url" type="text" class="form-control">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- END 数据查询-->
        <!-- BEGIN 表格数据-->
        <div class="portlet box green-meadow">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-cogs"></i>数据列表
                </div>
                <div class="tools">
                    <button type="button" onclick="Add()" class="btn btn-circle btn-sm green-meadow">
                        <i class="fa fa-plus"></i> 新增
                    </button>
                    <button type="button" onclick="EditView()" class="btn btn-circle btn-sm green-meadow">
                        <i class="fa fa-pencil"></i> 修改
                    </button>
                    <button type="button" onclick="EditView('view')" class="btn btn-circle btn-sm green-meadow">
                        <i class="fa fa-table"></i> 查看
                    </button>
                    <button type="button" onclick="Delete()" class="btn btn-circle btn-sm green-meadow">
                        <i class="fa fa-minus"></i> 删除
                    </button>
                    <button type="button" onclick="Refresh()" class="btn btn-circle btn-sm green-meadow" data-toggle="modal">
                        <i class="fa fa-refresh"></i> 刷新
                    </button>
                    <button type="button" class="fullscreen btn btn-circle btn-sm green-meadow" data-original-title="全屏">
                        <i class="icon-size-fullscreen"></i>
                    </button>
                </div>
            </div>
            <div class="portlet-body flip-scroll">
                <div class="portlet-body">
                    <div>
                        <table id="grid" class="table table-hover"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--------------------------添加/修改信息的弹出层---------------------------->
<div class="modal fade" id="add" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">
                    <i class="icon-pencil"></i>
                    <span id="lblAddTitle" style="font-weight:bold">添加信息</span>
                </h4>
            </div>
            <form class="form-horizontal form-bordered form-row-stripped" id="ffAdd" action="">
                <div class="modal-body">
                    <div class="row">
                        <!--父菜单,系统编号,显示名称,排序,功能ID,菜单可见,Web链接地址,Web图标（单击右侧设置图标）-->
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label col-md-4">父菜单<span class="required">*</span></label>
                                <div class="input-icon col-md-8">
                                    <select id="PID" name="PID" class="form-control select2" required></select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label col-md-4">系统编号<span class="required">*</span></label>
                                <div class="input-icon col-md-8">
                                    <select id="SystemType_ID" name="SystemType_ID" class="form-control select2" placeholder="系统编号..." required></select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label col-md-4">显示名称<span class="required">*</span></label>
                                <div class="col-md-8">
                                    <input id="Name" name="Name" type="text" class="form-control" placeholder="显示名称..." required>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label col-md-4">菜单是否可见</label>
                                <div class="col-md-8">
                                    <label>
                                        <input type="hidden" id="hVisible" name="Visible" />
                                        <input id="Visible" type="checkbox" class="icheck" data-checkbox="icheckbox_square-red" />不可见
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label col-md-4">排序</label>
                                <div class="col-md-8">
                                    <input id="Seq" name="Seq" type="text" class="form-control" placeholder="排序...">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label col-md-4">功能ID</label>
                                <div class="col-md-8">
                                    <div class="input-group">
                                        <input id="FunctionId" name="FunctionId" type="text" class="form-control" placeholder="功能ID...">
                                        <span class="input-group-btn">
                                            <button id="btnSelect" class="btn btn-success" type="button" onclick="selectFunction()">
                                                <i class="glyphicon glyphicon-list" ></i>选择功能
                                            </button>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label col-md-4">Web链接地址</label>
                                <div class="col-md-8">
                                    <input id="Url" name="Url" type="text" class="form-control" placeholder="Web链接地址...">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label col-md-4">Web图标</label>
                                <div class="input-icon col-md-8">
                                    <input id="WebIcon" name="WebIcon" type="hidden" value="icon-screen-tablet" />
                                    <span id="i_WebIcon" aria-hidden="true" class="icon-screen-tablet" style="font-size: 2.0em"></span>
                                    <a href="javascript:;" class="btn btn-sm blue" onclick="SelectIcon()">
                                    选择图标
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label col-md-4">特殊标签</label>
                                <div class="input-icon col-md-8">
                                    <input id="Tag" name="Tag" type="text" class="form-control" placeholder="特殊标签...">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="hidden" id="ID" name="ID" />
                    <button type="submit" class="btn blue">确定</button>
                    <button type="button" class="btn green" data-dismiss="modal">取消</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="view" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">
                    <i class="icon-book-open"></i>
                    <b>查看信息</b>
                </h4>
            </div>
            <form class="form-horizontal form-bordered form-row-stripped" id="ffView" action="">
                <input name="ID2" type="hidden" value="">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label col-md-4">系统编号</label>
                                <div class="col-md-8">
                                    <label id="SystemType_ID2" class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label col-md-4">显示名称</label>
                                <div class="col-md-8">
                                    <label id="Name2" class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label col-md-4">排序</label>
                                <div class="col-md-8">
                                    <label id="Seq2" class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label col-md-4">功能</label>
                                <div class="col-md-8">
                                    <label id="FunctionId2" class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label col-md-4">菜单可见</label>
                                <div class="col-md-8">
                                    <label id="Visible2" class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label col-md-4">Web链接地址</label>
                                <div class="col-md-8">
                                    <label id="Url2" class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label col-md-4">Web图标</label>
                                <div class="col-md-8">
                                    <label id="WebIcon2" class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label col-md-4">特殊标签</label>
                                <div class="col-md-8">
                                    <label id="Tag2" class="form-control" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn green-meadow" data-dismiss="modal">关闭</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade bs-modal-lg" id="icon" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">
                    <i class="icon-book-open"></i>
                    <b>查看图标信息</b>
                </h4>
            </div>
            <div class="modal-body">
                <div class="clearfix">
                    <div class="btn-group btn-group-circle" data-toggle="buttons" id="btnIconType">
                        <label class="btn green active" onclick="RefreshIcon()">
                            <input type="radio" class="toggle" value="SimpleLine"> SimpleLine
                        </label>
                        <label class="btn green-meadow" onclick="RefreshIcon()">
                            <input type="radio" class="toggle" value="FontAwesome"> FontAwesome
                        </label>
                        <label class="btn green-meadow" onclick="RefreshIcon()">
                            <input type="radio" class="toggle" value="Glyphicons"> Glyphicons
                        </label>
                    </div>
                </div>
                <div class="portlet-body" id="icon_body">
                </div>
                <div class="paging-toolbar">
                    <ul id='icon_paging'></ul>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn green-meadow" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade bs-modal-lg" id="functionDiv" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">
                    <i class="icon-book-open"></i>
                    <b>选择功能</b>
                </h4>
            </div>
            <div class="modal-body">
                <div id="jstree_divSelect"></div>                
            </div>

            <div class="modal-footer">
                <div class="row" style="float:left">
                    选中的功能：
                    <span id="selectedFunction"></span>
                    <input type="hidden" id="selectedFunctionId"/>  
                </div>
                <button id="functionDivOK" class="btn blue" onclick="confirmFunction()">确定</button>
                <button type="button" class="btn green-meadow" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!--导入数据操作层-->
<div id="import" class="modal fade bs-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">文件导入</h4>
            </div>
            <div class="modal-body">
                <div style="text-align:right;padding:5px">
                    <a href="~/Content/Template/Menu-模板.xls" onclick="javascript:Preview();">
                        <img alt="文件导入-模板" src="~/Content/images/ico_excel.png" />
                        <span style="font-size:larger;font-weight:200;color:red">Menu-模板.xls</span>
                    </a>
                </div>
                <hr />
                <form id="ffImport" method="post">
                    <div title="Excel导入操作" style="padding: 5px">
                        <input type="hidden" id="AttachGUID" name="AttachGUID" />
                        <input id="excelFile" type="file">
                    </div>
                </form>

                <!--数据显示表格-->
                <table id="gridImport" class="table table-striped table-bordered table-hover" cellpadding="0" cellspacing="0" border="0"></table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="SaveImport()">保存</button>
            </div>
        </div>
    </div>
</div>


@section footerScript{
    <script type="text/javascript">
        var currentPage = 1, rows = 10; //分页参数：当前页，记录数
        var gCondition = "";

        var isAddOrEdit = 'add';//标识是新增还是编辑对话框弹出，用于删除附件的操作
        var url;//新增或者更新的连接
        var ID;//ID值，新增为空，编辑或者查看为具体ID

        //页面初始化
        $(function () {
            initJsTree(); //初始化树

            BindEvent();        //绑定事件处理
            Search(currentPage);//初始化第一页数据
            InitDictItem();     //初始化字典信息
        });

        //绑定左侧树形列表
        function initJsTree() {
            bindJsTree("jstree_div", "/Menu/GetMenuJsTreeJson");
            $("#jstree_div").bind("dblclick.jstree", function (e, data) {
                var id = $(e.target).parents('li').attr('id');
                EditViewById(id);
            });

            //树控件的变化事件处理
            $('#jstree_div').on("changed.jstree", function (e, data) {
                var icon = data.node.icon;
                if (icon != true && icon.indexOf("fa fa-home") >= 0) {
                    loadDataWithSystemType(data.selected)
                } else {
                    loadData(data.selected);
                }
            });
        }

        function refreshTree(loaded) {
            bindJsTree("jstree_div", "/Menu/GetMenuJsTreeJson", loaded);
        }

        //加载指定的对象数据
        var clickId = "";
        var systemtype = "";
        var where = {};//树列表条件
        function loadData(id) {
            var condition = { WHC_PID: id + '' };
            where = {};//清空
            where["WHC_PID"] = id + '';//使用自定义条件
            //修改条件后需要重新刷新
            $table.bootstrapTable('refresh', { url: queryUrl, query: condition, pageNumber: 1 });

            clickId = id;
        }
        function loadDataWithSystemType(systemTypeId) {
            var condition = { WHC_SystemType_ID: systemTypeId, WHC_PID: -1 };
            where = {};//清空
            where["WHC_SystemType_ID"] = systemTypeId;//使用自定义条件
            where["WHC_PID"] = -1;//使用自定义条件

            //修改条件后需要重新刷新
            $table.bootstrapTable('refresh', { url: queryUrl, query: condition, pageNumber: 1 });

            systemtype = systemTypeId;//顶级设置为-1
        }

        var $table;
        var queryUrl;
        //初始化bootstrap-table的内容
        function Search(page) {
            //记录页面bootstrap-table全局变量$table，方便应用
            queryUrl = '/Menu/FindWithPager?rnd=' + Math.random()
            $table = $('#grid').bootstrapTable({
                url: queryUrl,             		    //请求后台的URL（*）
                method: 'GET',                      //请求方式（*）
                //toolbar: '#toolbar',              //工具按钮用哪个容器
                striped: true,                      //是否显示行间隔色
                cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
                pagination: true,                   //是否显示分页（*）
                sortable: true,                     //是否启用排序
                sortOrder: "asc",                   //排序方式
                sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
                pageNumber: page,                      //初始化加载第一页，默认第一页,并记录
                pageSize: rows,                     //每页的记录行数（*）
                pageList: [10, 25, 50, 100],        //可供选择的每页的行数（*）
                search: false,                      //是否显示表格搜索
                strictSearch: true,
                showColumns: true,                  //是否显示所有的列（选择显示的列）
                showRefresh: true,                  //是否显示刷新按钮
                minimumCountColumns: 2,             //最少允许的列数
                clickToSelect: true,                //是否启用点击选中行
                //height: 500,                      //行高，如果没有设置height属性，表格自动根据记录条数觉得表格高度
                uniqueId: "ID",                     //每一行的唯一标识，一般为主键列
                showToggle: true,                   //是否显示详细视图和列表视图的切换按钮
                cardView: false,                    //是否显示详细视图
                detailView: false,                  //是否显示父子表
                //得到查询的参数
                queryParams: function (params) {
                    //这里的键的名字和控制器的变量名必须一致，这边改动，控制器也需要改成一样的

                    //var temp = {   
                    //    rows: params.limit,                         //页面大小
                    //    page: (params.offset / params.limit) + 1,   //页码
                    //    sort: params.sort,      //排序列名  
                    //    sortOrder: params.order //排位命令（desc，asc） 
                    //};
                    //return temp;

                    var temp = $("#ffSearch").serializeJsonObject();
                    temp["rows"] = params.limit;                        //页面大小
                    temp["page"] = (params.offset / params.limit) + 1;  //页码
                    temp["sort"] = params.sort;                         //排序列名
                    temp["sortOrder"] = params.order;                   //排位命令（desc，asc） 

                    //特殊格式的条件处理
                    //temp["WHC_Age"] = $("#WHC_Age").val() + "~" + $("#WHC_Age2").val();
                    //temp["WHC_BirthDate"] = $("#WHC_BirthDate").val() + "~" + $("#WHC_BirthDate2").val();

                    //如果自定义条件非空，加入条件
                    $.each(where, function (item) {
                        console.log(item, where[item]);
                        temp[item] = where[item];
                    });

                    return temp;
                },
                columns: [{
                    checkbox: true,
                    visible: true                  //是否显示复选框  
                },
                 { title: '显示名称', field: 'Name', width: 150, sortable: true },
                 { title: '排序', field: 'Seq', width: 60, sortable: true },
                 { title: '功能ID', field: 'FunctionId', width: 100, sortable: true },
                 { title: '菜单可见', field: 'Visible', width: 80, sortable: true, valign: 'middle', formatter: visibleFormatter },
                 { title: 'Web连接地址', field: 'Url' /*, width: 80, sortable: true */ },
                 { title: 'Web菜单图标', field: 'WebIcon', width: 80, valign: 'middle', formatter: webIconFormatter },
                 { title: '系统编号', field: 'SystemType_ID' /*, width: 80, sortable: true */ },
  				 { title: '操作', field: 'ID', width: 120, align: 'center', valign: 'middle', formatter: actionFormatter },
                ],
                onLoadSuccess: function () {
                    currentPage = page;//存储当前页码
                },
                onLoadError: function () {
                    //showTips("数据加载失败！");
                },
                onDblClickRow: function (row, $element) {
                    var id = row.ID;
                    EditViewById(id, 'view');
                }
            });
        };

        //根据条件查询并绑定结果
        var $import;
        function InitImport(guid) {
            var url = "/Menu/GetExcelData?guid=" + guid;
            $import = $('#gridImport').bootstrapTable({
                url: url,                           //请求后台的URL（*）
                method: 'GET',                      //请求方式（*）
                striped: true,                      //是否显示行间隔色
                cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
                pagination: false,                  //是否显示分页（*）
                sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
                pageNumber: 1,                      //初始化加载第一页，默认第一页,并记录
                pageSize: 100,                     //每页的记录行数（*）
                pageList: [10, 25, 50, 100],        //可供选择的每页的行数（*）
                search: false,                      //是否显示表格搜索
                strictSearch: true,
                showColumns: true,                  //是否显示所有的列（选择显示的列）
                showRefresh: true,                  //是否显示刷新按钮
                minimumCountColumns: 2,             //最少允许的列数
                clickToSelect: true,               //是否启用点击选中行
                uniqueId: "ID",                     //每一行的唯一标识，一般为主键列
                queryParams: function (params) { },
                columns: [{
                    checkbox: true,
                    visible: true                  //是否显示复选框  
                },
                 { title: '显示名称', field: 'Name' /*, width: 80, sortable: true */ },
                 { title: '图标', field: 'Icon' /*, width: 80, sortable: true */ },
                 { title: '排序', field: 'Seq' /*, width: 80, sortable: true */ },
                 { title: '功能ID', field: 'FunctionId' /*, width: 80, sortable: true */ },
                 { title: '是否可见', field: 'Visible' /*, width: 80, sortable: true */ },
                 { title: 'Web连接地址', field: 'Url' /*, width: 80, sortable: true */ },
                 { title: 'Web菜单图标', field: 'WebIcon' /*, width: 80, sortable: true */ },
                 { title: '系统编号', field: 'SystemType_ID' /*, width: 80, sortable: true */ },
                ],
                onLoadSuccess: function () {
                },
                onLoadError: function () {
                    //showTips("数据加载失败！");
                },
            });
        }

        //图片格式化
        function imageFormatter(value, row, index) {
            return "<img src='" + value + "' style='width:50px; height:50px;' />";
        }
        //日期字段格式化
        function dateFormatter(value, row, index) {
            return getDateStr(value);
        }
        //连接字段格式化
        function linkFormatter(value, row, index) {
            return "<a href='" + value + "' title='单击打开连接' target='_blank'>" + value + "</a>";
        }
        //Email字段格式化
        function emailFormatter(value, row, index) {
            return "<a href='mailto:" + value + "' title='单击打开连接'>" + value + "</a>";
        }
        //性别字段格式化
        function sexFormatter(value) {
            if (value == "女") { color = 'Red'; }
            else if (value == "男") { color = 'Green'; }
            else { color = 'Yellow'; }

            return '<div  style="color: ' + color + '">' + value + '</div>';
        }
        //是否可见
        function visibleFormatter(value) {
            var result = "";
            if (value) {
                result = "<span class='label label-success'>可见</span>";
            }
            else {
                result = "<span class='label label-danger'>不可见</span>";
            }
            return result;
        }
        //菜单图标
        function webIconFormatter(value) {
            var result = "";
            if (value != "") {
                result = "<span class='"+ value  +"'></span>";
            }
            return result;
        }
        
        //操作栏的格式化
        function actionFormatter(value, row, index) {
            var id = value;
            var result = "";
            result += "<a href='javascript:;' class='btn btn-xs green' onclick=\"EditViewById('" + id + "', view='view')\" title='查看'><span class='glyphicon glyphicon-search'></span></a>";
            result += "<a href='javascript:;' class='btn btn-xs blue' onclick=\"EditViewById('" + id + "')\" title='编辑'><span class='glyphicon glyphicon-pencil'></span></a>";
            result += "<a href='javascript:;' class='btn btn-xs red' onclick=\"DeleteByIds('" + id + "')\" title='删除'><span class='glyphicon glyphicon-remove'></span></a>";

            return result;
        }

        //自定义函数处理queryParams的批量增加
        $.fn.serializeJsonObject = function () {
            var json = {};
            var form = this.serializeArray();
            $.each(form, function () {
                if (json[this.name]) {
                    if (!json[this.name].push) {
                        json[this.name] = [json[this.name]];
                    }
                    json[this.name].push();
                } else {
                    json[this.name] = this.value || '';
                }
            });
            return json;
        }

        //刷新列表
        function Refresh() {
            //Search(currentPage);
            where = {};//清空
            $table.bootstrapTable('refresh');
        }

        //初始化字典信息（下拉列表）
        function InitDictItem() {
            //BindDictItem("Titles", "职称");
            //BindDictItem("Rank", "职务");

            BindSelect("PID", "/Menu/GetDictJson");
            BindSelect("SystemType_ID", "/SystemType/GetDictJson", '系统类型', function () {
                $("#SystemType_ID").val('@IOT.MVCWebMis.Controllers.ConfigData.SystemType').trigger("change");
            });
        }

        //实现删除数据的方法
        function Delete() {
            var ids = "";//得到用户选择的数据的ID
            var rows = $table.bootstrapTable('getSelections');
            for (var i = 0; i < rows.length; i++) {
                ids += rows[i].ID + ',';
            }
            ids = ids.substring(0, ids.length - 1);

            DeleteByIds(ids);
        }

        //删除指定的记录
        function DeleteByIds(ids) {
            if (ids != "") {
                showDelete(function () {
                    //最后去掉最后的逗号,
                    ids = ids.replace(/,\s*$/, '');

                    //然后发送异步请求的信息到后台删除数据
                    var postData = { ids: ids };
                    $.post("/Menu/DeletebyIds", postData, function (json) {
                        var data = $.parseJSON(json);
                        if (data.Success) {
                            showTips("删除选定的记录成功");
                            refreshTree(loadData(clickId));
                        }
                        else {
                            showTips(data.ErrorMessage);
                        }
                    });
                });
            } else {
                showTips("请选择你要删除的数据");
            }
        }


        //显示选择的功能列表
        function initSelectFunction() {
            bindJsTree("jstree_divSelect", "/Function/GetAllJsTreeJson");

            //树控件的变化事件处理
            $('#jstree_divSelect').on("changed.jstree", function (e, data) {
                var icon = data.node.icon;
                $("#selectedFunction").text(data.node.text);
                $("#selectedFunctionId").val(data.selected);
            });
        }
        function selectFunction() {
            initSelectFunction();
            $("#functionDiv").modal("show");
        }

        function confirmFunction() {
            var functionid = $("#selectedFunctionId").val();

            //解析获得功能键
            $.getJSON("/Function/FindByID?r=" + Math.random() + "&id=" + functionid, function (info) {
                $("#FunctionId").val(info.ControlID);
            });
            $("#functionDiv").modal("hide");
        }

        //弹出新增对话框
        function Add() {
            isAddOrEdit = 'add';//新增对话框标识
            $("#ffAdd")[0].reset();//清空上次输入
            $('#ffAdd').validate().resetForm();//去除验证信息

            url = '/Menu/Insert';
            $.get("/Menu/NewGuid?r=" + Math.random(), function (result) {
                $("#ID").val(result);
                ID = result;
            });

            //清空icheckbox的值
            $("#Visible").iCheck('uncheck');
            //清空Select2控件的值
            $("#PID").val(clickId).trigger("change");
            $("#SystemType_ID").val('@IOT.MVCWebMis.Controllers.ConfigData.SystemType').trigger("change");
            //$("#SystemType_ID").val(systemtype).trigger("change");

            $("#lblAddTitle").text("添加信息");
            $("#add").modal("show");
        }

        //修改或查看明细信息（绑定显示数据）
        function EditView(view) {
            ID = "";//重置ID的值
            var rows = $table.bootstrapTable('getSelections');
            if (rows.length > 0) {
                ID = rows[0].ID;
            }

            EditViewById(ID, view);
        }

        //编辑或者查看指定记录
        function EditViewById(ID, view) {
            if (ID == "") {
                showTips("请选择一条记录");
                return;
            }

            if (view == null) {
                //处理修改的信息
                $("#lblAddTitle").text("修改信息");
                $("#add").modal("show");
                url = '/Menu/Update?ID=' + ID;
                //绑定修改详细信息的方法
                BindEditInfo(ID);
            }
            else {
                //处理查看详细
                $("#view").modal("show");
                //绑定查看详细信息方法
                BindViewInfo(ID);
            }
        }

        //绑定编辑详细信息的方法
        function BindEditInfo(ID) {
            //使用同步方式，使得联动的控件正常显示
            $.ajaxSettings.async = false;
            $('#ffAdd').validate().resetForm();//去除验证信息

            //首先用户发送一个异步请求去后台实现方法
            $.getJSON("/Menu/FindByID?r=" + Math.random() + "&id=" + ID, function (info) {
                $("#ID").val(info.ID);
                $("#Name").val(info.Name);
                $("#Url").val(info.Url);

                $("#PID").val(info.PID).trigger("change");
                $("#SystemType_ID").val(info.SystemType_ID).trigger("change");

                $("#Seq").val(info.Seq);
                $("#FunctionId").val(info.FunctionId);
                if (info.Visible) {
                    $("#Visible").iCheck('uncheck');
                } else {
                    $("#Visible").iCheck('check');
                }
                //设置隐藏域的值
                $("#hVisible").val(info.Visible);

                //设置图标样式
                SetIconClass(info.WebIcon);

                isAddOrEdit = 'edit';//新增对话框标识
            });
        }

        //绑定查看详细信息的方法
        function BindViewInfo(ID) {
            //发送请求
            $.getJSON("/Menu/FindByID?r=" + Math.random() + "&id=" + ID, function (info) {
                $("#ID2").text(info.ID);
                $("#Name2").text(info.Name);
                $("#SystemType_ID2").text(info.SystemType_ID);
                $("#Seq2").text(info.Seq);
                $("#FunctionId2").text(info.FunctionId);
                $("#Visible2").text(info.Visible);
                $("#Url2").text(info.Url);
                $("#SystemType_ID2").text(info.SystemType_ID);
                $("#WebIcon2").text(info.WebIcon);
            });
        }

        //显示导入界面
        function ShowImport() {
            $("#import").modal("show");
        }

        //导出Excel数据
        function ShowExport() {
            var url = "/Menu/Export";
            var condition = $("#ffSearch").serialize();//获取条件

            executeExport(url, condition);//执行导出
        }

        //绑定相关事件
        function BindEvent() {
            //代码触发对添加界面控件的验证
            $("#add").validate();

            //对iCheck控件的切换处理，修改隐藏值
            $('#Visible').on('ifToggled', function (event) {
                $("#hVisible").val($(this).is(':unchecked'));
            });

            //判断表单的信息是否通过验证
            $("#ffAdd").validate({
                meta: "validate",
                errorElement: 'span',
                errorClass: 'help-block help-block-error',
                focusInvalid: false,
                highlight: function (element) {
                    $(element).closest('.form-group').addClass('has-error');
                },
                success: function (label) {
                    label.closest('.form-group').removeClass('has-error');
                    label.remove();
                },
                errorPlacement: function (error, element) {
                    element.parent('div').append(error);
                },
                submitHandler: function (form) {
                    $("#add").modal("hide");
                    //构造参数发送给后台
                    var postData = $("#ffAdd").serializeArray();
                    $.post(url, postData, function (json) {
                        var data = $.parseJSON(json);
                        if (data.Success) {
                            //可增加其他处理

                            //保存成功  1.关闭弹出层，2.刷新表格数据
                            showTips("保存成功");
                            //initJsTree();//刷新菜单树
                            refreshTree(loadData(clickId));
                        }
                        else {
                            showError("保存失败:" + data.ErrorMessage, 3000);
                        }
                    }).error(function () {
                        showTips("您未被授权使用该功能，请联系管理员进行处理。");
                    });
                }
            });

            //回车进行查询
            if (document.addEventListener) {
                //如果是Firefox  
                document.addEventListener("keypress", enterEvent, true);
            } else {
                //如果是IE
                document.attachEvent("onkeypress", enterEvent);
            }
        }
        //按下Enter搜索
        function enterEvent(evt) {
            if (evt.keyCode == 13) {
                //$("#btnSearch").click();
                Refresh();        
                evt.preventDefault();  //阻止事件冒泡
            }
        }


        //图标查询
        var iconCurrentPage = 1;
        function IconSearch(page) {
            var activeSourceType = $("#btnIconType").find("label.active").find("input").prop('value');
            var condition = "WHC_SourceType=" + activeSourceType;//SimpleLine,FontAwesome,Glyphicons
            IconSearchCondition(page, condition);
        }

        function IconSearchCondition(page, condition) {
            var iconrows = 50;
            var iconUrl = "../BootstrapIcon/FindWithPager?page=" + page + "&rows=" + iconrows;

            $.getJSON(iconUrl + "&" + condition, function (data) {
                $("#icon_body").html("");
                $.each(data.rows, function (i, item) {
                    var tr = "<a href=\"javascript:;\" onclick=\"GetIcon('" + item.ClassName + "')\" class=\"icon-btn\" title=\"" + item.DisplayName + "\">";
                    tr += "    <i class=\"" + item.ClassName + " \" style=\"font-size: 2.2em\"></i>";//
                    //tr += "<div>" + item.DisplayName + "</div>";
                    tr += "</a>";
                    $("#icon_body").append(tr);
                });

                var element = $('#icon_paging');
                if(data.total > 0) {
                    var options = {
                        bootstrapMajorVersion: 3,
                        currentPage: page,
                        numberOfPages: iconrows,
                        totalPages: Math.ceil(data.total / iconrows),
                        onPageChanged: function (event, oldPage, newPage) {
                            IconSearchCondition(newPage, condition);
                        }
                    }
                    element.bootstrapPaginator(options);
                } else {
                    element.html("");
                }
            });
        }
        //刷新图标
        function RefreshIcon() {
            IconSearch(iconCurrentPage);
        }

        //选择图标事件
        function SelectIcon() {
            IconSearch(iconCurrentPage);
            $("#icon").modal("show");
        }
        function GetIcon(classname) {
            SetIconClass(classname);
            $("#icon").modal("hide");
        }
        function SetIconClass(classname) {
            $("#WebIcon").val(classname);
            $("#i_WebIcon").attr("class", classname);
        }
    </script>
}
